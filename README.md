# Домашнее задание к занятию "`Очереди RabbitMQ`" - `Дёмин Максим`


### Задание 1

Что нужно сделать:

Установка RabbitMQ

Используя Vagrant или VirtualBox, создайте виртуальную машину и установите RabbitMQ. Добавьте management plug-in и зайдите в веб-интерфейс.

### Решение:

1. запускаем [Vagrant](img/01.png)
   ``` vagrant up``` ([vagrant](script/Vagrantfile) [provision.sh](script/provision.sh))

2. заходим на [веб интерфейс](img/02.png) [2](img/03.png) [3](img/04.png) 


### Задание 2

Что нужно сделать:

Отправка и получение сообщений

Используя приложенные скрипты, проведите тестовую отправку и получение сообщения. Для отправки сообщений необходимо запустить скрипт producer.py.

Для работы скриптов вам необходимо установить Python версии 3 и библиотеку Pika. Также в скриптах нужно указать IP-адрес машины, на которой запущен RabbitMQ, заменив localhost на нужный IP.

Зайдите в веб-интерфейс, найдите очередь под названием hello и сделайте скриншот. После чего запустите второй скрипт consumer.py и сделайте скриншот результата выполнения скрипта

### Решение:

1. Запускаем [скрипт отправки сообщения](img/05.png) [producer.py](script/producer.py)

2. заходим в веб интерфейс в раздел [очереди](img/06.png)

3. нажимаем [получить сообщение](img/07.png)

4. запускаем скрипт для [получения сообщения](img/08.png) [consumer.py](script/consumer.py)

5. проверяем на веб интерфейсе что сообщение удалено из [очереди](img/09.png)

[6](img/10.png)

[7](img/11.png)


### Задание 3

Что нужно сделать:

 Подготовка HA кластера
 
Используя Vagrant или VirtualBox, создайте вторую виртуальную машину и установите RabbitMQ. Добавьте в файл hosts название и IP-адрес каждой машины, чтобы машины могли видеть друг друга по имени.

Пример содержимого hosts файла:

```
$ cat /etc/hosts
192.168.0.10 rmq01
192.168.0.11 rmq02
```
После этого ваши машины могут пинговаться по имени.

Затем объедините две машины в кластер и создайте политику ha-all на все очереди.

В качестве решения домашнего задания приложите скриншоты из веб-интерфейса с информацией о доступных нодах в кластере и включённой политикой.

Также приложите вывод команды с двух нод:

```
$ rabbitmqctl cluster_status
```
Для закрепления материала снова запустите скрипт producer.py и приложите скриншот выполнения команды на каждой из нод:

```
$ rabbitmqadmin get queue='hello'
```

После чего попробуйте отключить одну из нод, желательно ту, к которой подключались из скрипта, затем поправьте параметры подключения в скрипте consumer.py на вторую ноду и запустите его.

### Решение:

1. запускаем [Vagrant](img/01.png)
   ``` vagrant up``` ([vagrant](script/claster/Vagrantfile) [provision.sh](script/claster/provision.sh))

2. заходим на веб интерфейс [rmq01](img/16.png)

3. заходим на веб интерфейс [rmq02](img/17.png)

4. проверяем политику ha-all на все очереди на [rmq01](img/18.png)

5. проверяем политику ha-all на все очереди на [rmq02](img/19.png)

6. проверяем состояние кластера на [rmq01](img/20.png)

7. проверяем состояние кластера на [rmq02](img/21.png)

8. отправляем сообщение  [скрипт отправки сообщения](img/24.png) [producer.py](script/producer.py)

9. проверяем очереди в веб интерфейсе на [rmq01](img/22.png) и [rmq02](img/23.png)

10. отправляем сообщение на rmq01, затем останавливаем rmq01, и получаем сообщение с [rmq02](img/26.png)


### Задание 4

Что нужно сделать:

Ansible playbook

Напишите плейбук, который будет производить установку RabbitMQ на любое количество нод и объединять их в кластер. При этом будет автоматически создавать политику ha-all.


### Решение:

Так как нет уточнения каким образом производим установку, и какие хосты используем, ставим RabbitMQ из репозитория Ubuntu включаем management, создаём пользователя, собираем кластер на любое число нод (seed = первая нода в группе), и создаём политику ha-all используем [inventory.ini](script/claster/inventory.ini)

1. [Playbook](script/claster/rabbitmq_cluster.yml)


